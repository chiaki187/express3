<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <link rel="stylesheet" href="index.css">
    <script src="app.js"></script>
    <style>

      .center{
        text-align: center;       
      }

      .title{
        font-size: 2em;
      }
      .title-Space{
        margin-top: 100px;
      }
      .msg-Fromgame{
        font-size: 1.5em;
        color: #5f5f5f;
      }
      .setColorHightLight{
        color:rgb(229, 100, 45)
      }
      .setColorGreen{
        color:rgb(113, 229, 45)
      }
      .setColorClear{
        color:rgb(113, 229, 255)
      }
      .startBtm{
        display: block;
        margin: 0 auto;
      }

      .retireBtm{
        display: block;
        margin-left: 100px;
       margin-right: auto
      
      }
      .finishBtm{
        display: flex;
        background-color: #f44336;
        color: white;
  
        margin-left: auto;
      }

      /*ゲームオーバーとかゲームクリアとかの文字サイズとか*/
      .bigSentence{
        font-size: 60px;
        margin-bottom: 200px;
      }

      /*retire,finishボタンの入れるコンテナ*/
      .button-container {
        display: flex;
        width:90%;
      }


      .gameFrame{
        width: 60%;
        height: 400px;
        border: 5px solid #000000;
        align-content: center;
        /*background-color: #ececf0;*/
        margin: 0 auto; 
        margin-bottom:50px;
        display: flex; /* Flexboxを有効にする */
        justify-content: center; /* 水平方向の中央揃え */
        align-items: center; /* 垂直方向の中央揃え */
        position: relative; /* ★これがあるか確認！★ */
        overflow: hidden;   /* ★これがあるか確認！枠からはみ出さないようにする★ */

      }
      .gameFrameBlack{
        width: 80%;
        height: 400px;
  
        border: 5px solid #000000;
        align-content: center;
        background-color: #8484ff;
        
       
      }
      /*メインの動かすキャラ*/
      .mainChara{
            width: 50px; /* 適宜調整してください */
            height: 50px; /* 適宜調整してください */
            background-color: #ffffff;
            border: 5px solid #b6e4f5;
            border-radius: 50%; /* これで要素が丸くなります */


            /* ★重要: JavaScriptで位置を制御するため追加★ */
            position: absolute;
            
            /* ★スムーズに動かすための遷移効果 (任意) ★ */
            transition: top 0.05s linear, left 0.05s linear;
      }

      /*敵キャラ*/
      .enemyChara{
            width: 50px; /* 適宜調整してください */
            height: 50px; /* 適宜調整してください */
            background-color: #ff2525;
            border: 5px solid #2d1512;
            border-radius: 50%; /* これで要素が丸くなります */


            /* ★重要: JavaScriptで位置を制御するため追加★ */
            position: absolute;
            
            /* ★スムーズに動かすための遷移効果 (任意) ★ */
            transition: top 0.05s linear, left 0.05s linear;
      }

      /*最初は非表示にしておく画面たち*/
      /*#gameScreen
      #SucccessConectScreen,
      #gameScreen {
        display: none;
      }*/
      

      
    </style>
  </head>
  <body>
    <!--最初に入った人の接続待ち画面-->
    <div id="waitingScreen">

      <h1 class="title title-Space center">ナビして！真っ暗</h1>
      <h1 class="title center">刑務所脱出ゲーム</h1>
      <h2 class="msg-Fromgame title-Space center">相手の接続を待っているよ</h2>
    </div>


    <!--接続が完了-->
    <div id="SucccessConectScreen">
      <h1 class="title title-Space center">ナビして！真っ暗</h1>
      <h1 class="title center">刑務所脱出ゲーム</h1>
      <h2 class="msg-Fromgame title-Space setColorHightLight center" id="BeforePush-startBtm style">接続が完了したよ！ゲーム開始ボタンを押そう↓</h2>
      <h2 class="msg-Fromgame title-Space setColorGreen center" id="AfterPush-startBtm" >相手がスタートボタンを押すのを待っているよ</h2>
      <button id="startButton" class="title startBtm center">ゲーム開始</button>
    </div>



    <!--ゲーム画面-->
    <div id="gameScreen">
      <h1 class="title center">ナビして！真っ暗 刑務所脱出ゲーム</h1>
      <h2 class="msg-Fromgame title-Space setColorHightLight center">ゲームが開始されたよ！</h2>
      <!--ゲームの枠-->
      
      <div id="gameFrame" class="gameFrame">
        <div id="mainChara" class="mainChara"></div><!--操作可能キャラ-->
        <div id="enemyChara1" class="enemyChara"></div><!--敵キャラ１-->
        <div id="enemyChara2" class="enemyChara"></div><!--敵キャラ２-->
       <div id="gameFrameBlack" class="gameFrameBlack"></div>
      </div>
      <div class="button-container">
        <button id="startButton" class="title retireBtm">ゲームリタイア</button>
        <button id="startButton" class="title finishBtm">ゲーム終了</button>
      </div>


       <!--ゲームオーバー画面-->
    <div id="gameOverScreen">
      <h1 class="title center">ナビして！真っ暗 刑務所脱出ゲーム</h1>
      <h1 class="bigSentence title-Space center setColorHightLight">Game Over</h1>
      <button id="startButton" class="title startBtm center">replay</button>
    </div>


    <!--ゲームクリア画面-->
    <div id="gameClearScreen">
      <h1 class="title center">ナビして！真っ暗 刑務所脱出ゲーム</h1>
      <h1 class="bigSentence title-Space center setColorClear">Game Clar!!!!</h1>
      <button id="startButton" class="title startBtm center">replay</button>
    </div>
      
    </div>






       <script>
    document.addEventListener('DOMContentLoaded', () => {
        const myCircle = document.getElementById('mainChara');
        const gameContainer = document.getElementById('gameFrame');
        const gameFrameBlack = document.getElementById('gameFrameBlack');

        let circleX = 0;
        let circleY = 150;

        myCircle.style.left = `${circleX}px`;
        myCircle.style.top = `${circleY}px`;
        myCircle.style.transform = 'none';

        let moveSpeed = 10;

        // キーボードイベントリスナー
        document.addEventListener('keydown', (e) => {
            let newX = circleX;
            let newY = circleY;

            // ...（キー入力によるメインキャラの移動ロジックはそのまま）...
            switch (e.key) {
                    case 'ArrowUp':
                        newY -= moveSpeed;
                        break;
                    case 'ArrowDown':
                        newY += moveSpeed;
                        break;
                    case 'ArrowLeft':
                        newX -= moveSpeed;
                        break;
                    case 'ArrowRight':
                        newX += moveSpeed;
                        break;
                    default:
                        return; // 矢印キー以外は処理しない
            }

            e.preventDefault();

            newX = Math.max(0, Math.min(newX, gameContainer.offsetWidth - myCircle.offsetWidth));
            newY = Math.max(0, Math.min(newY, gameContainer.offsetHeight - myCircle.offsetHeight));

            circleX = newX;
            circleY = newY;
            myCircle.style.left = `${circleX}px`;
            myCircle.style.top = `${circleY}px`;
        });

       // ウィンドウリサイズ時の処理
            window.addEventListener('resize', () => {
                // コンテナと円のサイズを再取得
                gameFrameWidth = gameFrame.offsetWidth;
                    gameFrameHeight = gameFrame.offsetHeight;
                circleX = gameContainer.offsetWidth / 2 - myCircle.offsetWidth / 2;
                circleY = gameContainer.offsetHeight / 2 - myCircle.offsetHeight / 2;
                myCircle.style.left = `${circleX}px`;
                myCircle.style.top = `${circleY}px`;
            });
         
            // 敵キャラ設定
        const enemyChara1 = document.getElementById('enemyChara1');
        let enemy1X = 100;
        let enemy1Y = 100;
        let enemySpeed1 = 2;
        let enemy1DirectionX = 1;
        let enemy1DirectionY = 1;

        const enemyChara2 = document.getElementById('enemyChara2');
        let enemy2X = 300;
        let enemy2Y = 300;
        let enemySpeed2 = 2.5;
        let enemy2DirectionX = -1;
        let enemy2DirectionY = 1;

        

        function animate() {
           // 敵キャラ１を自動で動かすロジックをここに移動
            enemy1X += enemySpeed1 * enemy1DirectionX;
            enemy1Y += enemySpeed1 * enemy1DirectionY;
            
            if (enemy1X + enemyChara1.offsetWidth+80 >= gameContainer.offsetWidth || enemy1X <=80) {
                enemy1DirectionX *= -1;
            }
            if (enemy1Y + enemyChara1.offsetHeight >= gameContainer.offsetHeight || enemy1Y <= 0) {
                enemy1DirectionY *= -1;
            }

            enemyChara1.style.left = `${enemy1X}px`;
            enemyChara1.style.top = `${enemy1Y}px`;


             // 敵キャラ２を自動で動かすロジックをここに移動
            enemy2X += enemySpeed2 * enemy2DirectionX;
            enemy2Y += enemySpeed2 * enemy2DirectionY;
            
            if (enemy2X + enemyChara2.offsetWidth+80 >= gameContainer.offsetWidth || enemy2X <=80) {
                enemy2DirectionX *= -1;
            }
            if (enemy2Y + enemyChara2.offsetHeight >= gameContainer.offsetHeight || enemy2Y <= 0) {
                enemy2DirectionY *= -1;
            }

            enemyChara2.style.left = `${enemy2X}px`;
            enemyChara2.style.top = `${enemy2Y}px`;



            //敵キャラとの衝突判定----------------------

            //ぶつかった基準
            const deadline=2500;
            
            // 主人公キャラの中心座標を計算
            let mainCharaCenterX=circleX+25;
            let mainCharaCenterY=circleY+25;


            // 敵キャラ１の中心座標を計算
            let enemy1CenterX = enemy1X + 25;
            let enemy1CenterY = enemy1Y + 25;

            // 敵キャラ2の中心座標を計算
            let enemy2CenterX = enemy2X + 25;
            let enemy2CenterY = enemy2Y + 25;

            let distance1=Math.pow((mainCharaCenterX-enemy1CenterX),2)+Math.pow((mainCharaCenterY-enemy1CenterY),2);
            let distance2=Math.pow((mainCharaCenterX-enemy2CenterX),2)+Math.pow((mainCharaCenterY-enemy2CenterY),2);

            //衝突したら
            if(distance1<deadline||distance2<deadline){
                enemySpeed1 = 0;
                enemySpeed2 = 0;
                moveSpeed = 0;
                gameFrameBlack.style.backgroundColor="#ff0000";
                //サーバーにゲームオーバーメッセージを送る

                // ★衝突したことをサーバーに送信★
              if (ws && ws.readyState === WebSocket.OPEN) {
                  const message = {
                      type: 'GameOver',
                      message: 'プレイヤーが敵と衝突しました！',
                  };
                  console.log('ゲームオーバーって送ったよ！');
                  ws.send(JSON.stringify(message));
              }
            }

            requestAnimationFrame(animate);
        }


        

        animate();
        

       
    });

    function main() {
        const host = location.origin.replace(/^http/, 'ws');
        const ws = new WebSocket(host + '/ws');
        const myId = self.crypto.randomUUID().substr(0, 8);

        const waitingScreen = document.getElementById('waitingScreen');
        const SucccessConectScreen = document.getElementById('SucccessConectScreen');
        const gameScreen = document.getElementById('gameScreen');

        ws.onmessage = function (msg) {
            const data = JSON.parse(msg.data);

            if (data.type === 'ready') {
                waitingScreen.style.display = "none";
                SucccessConectScreen.style.display = "block";
                return;
            }
            
            if (data.type === 'start_game') {
                console.log('ゲーム開始のメッセージを受け取ったよ！');
                SucccessConectScreen.style.display = "none";
                gameScreen.style.display = "block";
                const beforePushStartBtm = document.getElementById('BeforePush-startBtm');
                if (beforePushStartBtm) beforePushStartBtm.style.display = "none";
                const afterPushStartBtm = document.getElementById('AfterPush-startBtm');
                if (afterPushStartBtm) afterPushStartBtm.style.display = "none";
            }
        };

        ws.onopen = function () {
           ws.send(JSON.stringify({ type: 'ready', text: '接続完了' }));
        };

        ws.onclose = function () {
        };

        const startButton = document.getElementById('startButton');
        if (startButton) {
            startButton.onclick = function() {
                ws.send(JSON.stringify({ type: 'user_ready', id: myId }));
                console.log('スタートボタンを押したよ！');
                const beforePushStartBtm = document.getElementById('BeforePush-startBtm');
                if (beforePushStartBtm) beforePushStartBtm.style.display = "none";
                const afterPushStartBtm = document.getElementById('AfterPush-startBtm');
                if (afterPushStartBtm) afterPushStartBtm.style.display = "block";
                startButton.style.display = "none";
            };
        }
    }

    window.addEventListener('DOMContentLoaded', main);
</script>